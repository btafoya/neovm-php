# Caddyfile for PHP 8.3 Development Environment

# Main development site
localhost {
    root * /var/www/html
    php_fastcgi php:9000
    file_server

    # Enable automatic HTTPS for localhost
    tls internal

    # Development headers
    header {
        X-Debug-Info "NixVM PHP 8.3 Development"
        X-Powered-By "Caddy/NixVM"
    }

    # Enable CORS for development
    @cors_preflight {
        method OPTIONS
    }
    respond @cors_preflight 204 {
        header Access-Control-Allow-Origin *
        header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        header Access-Control-Allow-Headers "Content-Type, Authorization"
        header Access-Control-Max-Age 86400
    }

    # PHP file handling
    @php {
        path *.php
    }
    php_fastcgi @php php:9000

    # Static files with caching
    @static {
        file {
            try_files {path} {path}/ /index.php?{query}
        }
        path *.css *.js *.png *.jpg *.jpeg *.gif *.ico *.svg *.woff *.woff2
    }
    header @static Cache-Control max-age=31536000

    # API routes (if any)
    handle /api/* {
        php_fastcgi php:9000
        encode gzip
    }

    # Log requests
    log {
        output file /var/log/caddy/access.log {
            roll_size 10mb
            roll_keep 5
        }
        format json
    }
}

# Alternative domain for testing
dev.nixvm.localhost {
    root * /var/www/html
    php_fastcgi php:9000
    file_server

    tls internal

    # Development mode headers
    header X-Environment "Development"
}